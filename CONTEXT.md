# Техническая документация HLTV Parser

## Структура проекта

```
hltv-2/
├── run.py                  # Точка входа в приложение
├── requirements.txt        # Зависимости проекта
├── hltv.db                 # База данных SQLite
├── README.md               # Инструкции по использованию
├── DEVELOPMENT.md          # История разработки и планы на будущее
├── CONTEXT.md              # Этот файл
├── src/                    # Исходный код
│   ├── __init__.py
│   ├── main.py             # Основная логика приложения
│   ├── database.py         # Работа с базой данных
│   ├── config/             # Конфигурация приложения
│   ├── parser/             # Модули парсинга
│   │   ├── base.py         # Базовый класс парсера
│   │   ├── matches.py      # Парсер страницы предстоящих матчей
│   │   ├── results.py      # Парсер страницы результатов
│   │   └── match_details.py # Парсер страницы деталей матча
│   ├── collector/          # Модули сбора данных
│   │   └── matches.py      # Сбор данных о матчах из HTML файлов
│   └── check/              # Служебные скрипты
│       ├── migrate_db.py   # Миграция структуры БД
│       ├── rename_match_files.py # Переименование файлов матчей
│       └── update_parsed_matches.py # Обновление статуса матчей
└── storage/                # Хранилище данных
    └── html/               # HTML файлы матчей
```

## Основные модули и их функции

### Основные компоненты

- **run.py** - Точка входа в приложение, запускает main.py
- **src/main.py** - Обрабатывает аргументы командной строки, инициализирует компоненты, координирует выполнение задач
- **src/database.py** - Инициализирует соединение с базой данных и создает необходимые таблицы

### Парсинг данных (src/parser/)

- **base.py** - Базовый класс парсера с общей функциональностью (настройка Selenium, логирование)
- **matches.py** - Парсер страницы предстоящих матчей
- **results.py** - Парсер страницы результатов
- **match_details.py** - Парсер страницы деталей матча

### Сбор данных (src/collector/)

- **matches.py** - Обработка HTML-файлов и сохранение данных в БД

### Служебные скрипты (src/check/)

- **migrate_db.py** - Миграция данных между старой и новой структурами базы данных
- **rename_match_files.py** - Переименование файлов матчей из старого формата в новый
- **update_parsed_matches.py** - Обновление статуса обработанных матчей

## Потоки данных

1. **Сбор страниц матчей**:

   - `main.py --parse-matches` → parser/matches.py → сохранение HTML в storage/html
   - `main.py --parse-results` → parser/results.py → сохранение HTML в storage/html

2. **Анализ загруженных страниц**:

   - `main.py --collect` → collector/matches.py → чтение HTML файлов → сохранение данных в БД

3. **Сбор деталей матчей**:
   - `main.py --parse-details` → parser/match_details.py → чтение ID из БД → сохранение HTML в storage/html

## База данных

### Таблица url_upcoming

```sql
CREATE TABLE IF NOT EXISTS url_upcoming (
    id INTEGER PRIMARY KEY,
    url TEXT NOT NULL,
    date INTEGER NOT NULL,
    toParse INTEGER NOT NULL DEFAULT 1
)
```

### Таблица url_result

```sql
CREATE TABLE IF NOT EXISTS url_result (
    id INTEGER PRIMARY KEY,
    url TEXT NOT NULL,
    toParse INTEGER NOT NULL DEFAULT 1
)
```

## Ключевые решения и особенности реализации

1. **Двухэтапный сбор данных**:

   - Сначала загружаются HTML страницы
   - Затем собираются данные из загруженных страниц

2. **Отдельные таблицы для предстоящих и завершенных матчей**:

   - Обеспечивает лучшую организацию данных
   - Упрощает отслеживание новых и обработанных матчей

3. **Информативные имена файлов**:

   - Файлы матчей именуются в формате match_ID-КОМАНДА1-vs-КОМАНДА2-ТУРНИР.html
   - Облегчает визуальную идентификацию матчей

4. **Система флагов toParse**:
   - Позволяет отслеживать, какие матчи уже обработаны
   - Предотвращает повторную обработку одних и тех же данных

## Технические детали

### Требования к окружению

- Python 3.8+
- Установленный ChromeDriver для Selenium
- Пакеты из requirements.txt

### Настройка окружения

```bash
# Настройка виртуального окружения
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows

# Установка зависимостей
pip install -r requirements.txt
```

### Параметры командной строки

См. [README.md](README.md) для подробного описания аргументов командной строки.
